<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MicroLearn — Flashcard & Quiz</title>
<style>
  :root{
    --bg:#0f1724;
    --card:#0b1220;
    --muted:#9aa4b2;
    --accent:#6ee7b7;
    --glass: rgba(255,255,255,0.04);
    --glass-2: rgba(255,255,255,0.02);
    --danger:#ff6b6b;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#071024 0%, #071827 60%);color:#e6eef6;}
  /* App frame */
  .app{
    max-width:460px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;
    padding:14px 12px 84px;
    box-sizing:border-box;
  }

  /* Header */
  header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
  .logo{display:flex;align-items:center;gap:10px}
  .logo .badge{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#3bd6b9);display:flex;align-items:center;justify-content:center;font-weight:700;color:#022;box-shadow:0 8px 20px rgba(11,18,32,0.6)}
  h1{font-size:1.05rem;margin:0}
  p.subtitle{margin:0;color:var(--muted);font-size:0.8rem}

  /* Quick controls */
  .controls{display:flex;gap:8px}
  .btn{
    background:var(--glass);border:1px solid rgba(255,255,255,0.03);color:var(--accent);
    padding:8px 12px;border-radius:12px;font-weight:600;font-size:0.9rem;cursor:pointer;backdrop-filter: blur(6px);
    box-shadow: 0 6px 18px rgba(2,6,23,0.5);
  }
  .btn.ghost{color:var(--muted);background:transparent;border:1px solid rgba(255,255,255,0.03)}
  .btn.positive{background:linear-gradient(90deg,var(--accent),#34d1b5);color:#022;border:none}
  .small{padding:6px 8px;font-size:0.85rem}

  /* Search & filters */
  .toolbar{display:flex;gap:8px;margin:10px 0 18px}
  .search{
    flex:1;background:var(--glass);padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);
    display:flex;gap:8px;align-items:center;color:var(--muted)
  }
  .search input{background:transparent;border:none;outline:none;color:inherit;width:100%}

  /* Category chips */
  .chips{display:flex;gap:8px;overflow:auto;padding-bottom:6px;margin-bottom:6px}
  .chip{padding:8px 12px;border-radius:999px;background:var(--glass-2);color:var(--muted);font-weight:600;font-size:0.85rem;white-space:nowrap;border:1px solid rgba(255,255,255,0.02)}
  .chip.active{background:linear-gradient(90deg,#0b1b2a, #06202e);color:var(--accent);box-shadow:0 6px 18px rgba(2,6,23,0.5)}

  /* Deck list */
  .deck-list{display:grid;grid-template-columns:1fr;gap:12px}
  .deck{
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(2,6,23,0.6);display:flex;flex-direction:column;gap:8px;border:1px solid rgba(255,255,255,0.03)
  }
  .deck .row{display:flex;align-items:center;justify-content:space-between;gap:8px}
  .deck .meta{display:flex;gap:8px;align-items:center}
  .type-pill{padding:6px 8px;border-radius:10px;font-weight:700;font-size:0.78rem;background:rgba(255,255,255,0.03)}
  .type-flash{color:#ffeaa7}
  .type-quiz{color:#b9d7ff}
  .deck .title{font-weight:700}
  .deck .desc{color:var(--muted);font-size:0.86rem}

  .deck-actions{display:flex;gap:8px;margin-top:8px}
  .action{padding:8px 10px;border-radius:10px;background:transparent;border:1px solid rgba(255,255,255,0.03);font-weight:700;color:var(--muted);cursor:pointer}

  /* Player */
  .player{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:20px;z-index:60}
  .player.open{display:flex}
  .player-sheet{width:100%;max-width:520px;background:linear-gradient(180deg,#07122a,#04101b);border-radius:18px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 30px 60px rgba(2,6,23,0.7)}
  .play-top{display:flex;align-items:center;justify-content:space-between}
  .play-card{margin-top:12px;min-height:210px;border-radius:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;cursor:pointer;transition:transform .35s;transform-origin:center;
    /* --- PERBAIKAN: Ditambahkan untuk mengaktifkan flip 3D --- */
    transform-style: preserve-3d;
  }
  .play-card.flip{transform:rotateY(180deg)}
  .card-inner{perspective:1000px;width:100%}
  .card-face{
    backface-visibility:hidden;transition:transform .6s;transform-style:preserve-3d;width:100%;
    border-radius:12px;padding:10px;
  }
  .face-front{transform:rotateY(0);min-height:140px;display:flex;align-items:center;justify-content:center;flex-direction:column}
  /* --- PERBAIKAN: Membersihkan gaya inline dan memindahkannya ke sini --- */
  .face-back{
    transform:rotateY(180deg);
    position:absolute;
    inset:0; /* Menggantikan left:0, top:0 */
    padding:18px; /* Menambahkan padding dari gaya inline */
    min-height:140px;
    display:flex;
    align-items:center;
    justify-content:center;
    flex-direction:column;
  }
  .card-wrap{position:relative;min-height:140px;width:100%}

  .nav-controls{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .nav-controls .navbtn{padding:10px 14px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,0.03);font-weight:700;cursor:pointer}

  /* Quiz options */
  .options{display:flex;flex-direction:column;gap:8px;margin-top:12px}
  .option{padding:12px;border-radius:10px;background:var(--glass-2);border:1px solid rgba(255,255,255,0.03);cursor:pointer;font-weight:700}
  .option.correct{border-color:rgba(110,231,183,0.6);background:linear-gradient(90deg, rgba(110,231,183,0.06), rgba(110,231,183,0.02))}
  .option.wrong{border-color:rgba(255,107,107,0.6);background:linear-gradient(90deg, rgba(255,107,107,0.03), rgba(255,107,107,0.01))}

  /* Bottom nav */
  .bottom-nav{position:fixed;left:0;right:0;bottom:14px;display:flex;justify-content:center;pointer-events:none}
  .nav{width:100%;max-width:520px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:8px 12px;display:flex;gap:8px;justify-content:space-between;align-items:center;pointer-events:auto;box-shadow:0 12px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
  .nav .nav-item{flex:1;text-align:center;padding:8px;border-radius:10px;color:var(--muted);font-weight:700;cursor:pointer}
  .nav .nav-item.active{color:var(--accent);background:linear-gradient(90deg, rgba(110,231,183,0.06), rgba(110,231,183,0.02))}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(2,6,23,0.55), rgba(2,6,23,0.6));z-index:90;padding:18px}
  .modal.open{display:flex}
  .modal-card{width:100%;max-width:520px;background:linear-gradient(180deg,#07122a,#04101b);border-radius:12px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
  label{display:block;color:var(--muted);font-size:0.82rem;margin-top:8px}
  input,textarea,select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;outline:none;margin-top:6px}
  textarea{min-height:72px;resize:vertical}
  .row-grid{display:flex;gap:8px}
  .muted{color:var(--muted);font-size:0.85rem}

  /* tiny helper */
  .empty{color:var(--muted);text-align:center;padding:26px;border-radius:12px;background:transparent}

  /* Loading spinner */
  .spinner-wrap{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;z-index:120}
  .spinner-wrap.show{display:flex}
  .spinner{width:64px;height:64px;border-radius:999px;border:8px solid rgba(255,255,255,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite;box-shadow:0 10px 30px rgba(2,6,23,0.6)}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* small screens fixes */
  @media (max-width:400px){
    .app{padding:12px 10px 92px}
    .logo .badge{width:40px;height:40px}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header>
    <div class="logo">
      <div class="badge">ML</div>
      <div>
        <h1>MicroLearn</h1>
        <p class="subtitle">Buat — Simpan — Mainkan belajar cepat</p>
      </div>
    </div>
    <div class="controls">
      <button class="btn small" id="btn-create">+ Unit</button>
      <button class="btn ghost small" id="btn-sync">API</button>
    </div>
  </header>

  <div class="toolbar">
    <div class="search">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <input id="q" placeholder="Cari judul atau kategori..." />
    </div>
    <button class="btn ghost" id="btn-clear">Clear</button>
  </div>

  <div class="chips" id="category-chips" aria-hidden="false">
    <!-- categories injected here -->
  </div>

  <div id="main-list" class="deck-list">
    <!-- deck cards -->
  </div>

  <div class="empty" id="empty-state" style="display:none">
    Belum ada learning unit. Tekan <strong>+ Unit</strong> untuk membuat flashcard atau quiz.
  </div>
</div>

<!-- Player -->
<div class="player" id="player">
  <div class="player-sheet" role="dialog" aria-modal="true">
    <div class="play-top">
      <div>
        <div id="player-type" class="muted">Flashcards</div>
        <div id="player-title" style="font-weight:800"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="muted" id="player-progress">0 / 0</div>
        <button class="btn small" id="player-close">Tutup</button>
      </div>
    </div>

    <div class="card-inner" style="margin-top:12px">
      <div class="card-wrap">
        <div class="play-card" id="play-card" tabindex="0" role="button" aria-pressed="false" title="Ketuk untuk membuka">
          <div class="face-front card-face" id="face-front">
            <div id="front-content" style="font-size:1.05rem;font-weight:800"></div>
            <div class="muted" style="margin-top:8px" id="front-sub"></div>
          </div>
          <!-- --- PERBAIKAN: Menghapus gaya inline yang berantakan --- -->
          <div class="face-back card-face" id="face-back">
            <div id="back-content" style="font-size:1rem;font-weight:700"></div>
            <div class="muted" id="back-sub" style="margin-top:8px"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="quiz-options-container" style="display:none">
      <div class="options" id="quiz-options"></div>
    </div>

    <div class="nav-controls">
      <button class="navbtn" id="prev-btn">&larr; Sebelumnya</button>
      <button class="navbtn" id="next-btn">Berikutnya &rarr;</button>
    </div>
  </div>
</div>

<!-- Modal: Create Unit -->
<div class="modal" id="modal">
  <div class="modal-card">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <h3 style="margin:0">Buat Learning Unit</h3>
        <div class="muted" style="font-size:0.84rem">Flashcard atau Quiz dibuat otomatis oleh AI / generator.</div>
      </div>
      <button class="btn ghost small" id="modal-close">X</button>
    </div>

    <label>Jenis</label>
    <select id="unit-type">
      <option value="flashcard">Flashcard (kartu)</option>
      <option value="quiz">Quiz (soal latihan)</option>
    </select>

    <label>Judul</label>
    <input id="unit-title" placeholder="Contoh: Sejarah Indonesia" />

    <label>Deskripsi singkat</label>
    <textarea id="unit-desc" placeholder="Ringkas materi atau tujuan pembelajaran"></textarea>

    <div class="row-grid" style="margin-top:8px">
      <div style="flex:1">
        <label>Jumlah</label>
        <input id="unit-count" type="number" value="5" min="1" max="30" />
      </div>
      <div style="flex:1">
        <label>Level (quiz)</label>
        <select id="unit-level">
          <option value="easy">Mudah</option>
          <option value="medium" selected>Sedang</option>
          <option value="hard">Sulit</option>
        </select>
      </div>
    </div>

    <label style="margin-top:8px">Kategori</label>
    <div style="display:flex;gap:8px">
      <select id="unit-category" style="flex:1"></select>
      <input id="new-category" placeholder="+ kategori baru" style="width:140px" />
    </div>

    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
      <button class="btn ghost" id="modal-cancel">Batal</button>
      <button class="btn positive" id="modal-create">Buat</button>
    </div>
  </div>
</div>

<!-- Spinner -->
<div class="spinner-wrap" id="spinner">
  <div class="spinner"></div>
</div>

<!-- simple toasts -->
<div id="toast" style="position:fixed;left:0;right:0;bottom:120px;display:flex;justify-content:center;pointer-events:none"></div>

<script>
/*
  MicroLearn single-file app
  - localStorage-based storage
  - Calls Gemini API for content generation
  - Falls back to internal generator on API failure
  - supports Flashcard and Quiz units
*/

/* ---------- Storage helpers ---------- */
const STORAGE_KEY = 'microlearn_decks_v1';

function readStorage(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]') }catch(e){ return [] }
}
function writeStorage(arr){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
}

/* ---------- Utilities ---------- */
function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function el(tag, attr={}, ...children){ const e=document.createElement(tag); for(let k in attr){ if(k==='class') e.className=attr[k]; else if(k==='html') e.innerHTML=attr[k]; else e.setAttribute(k, attr[k]); } children.forEach(c=>{ if(c===null) return; if(typeof c==='string') e.appendChild(document.createTextNode(c)); else e.appendChild(c); }); return e; }
function showSpinner(show){ document.getElementById('spinner').classList.toggle('show', !!show); }
function toast(msg, timeout=2200){
  const t = el('div',{class:'btn ghost', style:'pointer-events:auto;margin:6px'}, msg);
  const container = document.getElementById('toast');
  container.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(8px)'; }, timeout-300);
  setTimeout(()=> container.removeChild(t), timeout);
}

/* ---------- Gemini API integration ---------- */

// Definisikan skema JSON yang kita harapkan dari API
const flashcardSchema = {
  type: "OBJECT",
  properties: {
    cards: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          front: { type: "STRING" },
          back: { type: "STRING" }
        },
        required: ["front", "back"]
      }
    }
  },
  required: ["cards"]
};

const quizSchema = {
  type: "OBJECT",
  properties: {
    questions: {
      type: "ARRAY",
      items: {
        type: "OBJECT",
        properties: {
          question: { type: "STRING" },
          choices: { type: "ARRAY", items: { type: "STRING" } },
          answer: { type: "NUMBER", description: "Indeks (berbasis 0) dari jawaban yang benar" }
        },
        required: ["question", "choices", "answer"]
      }
    }
  },
  required: ["questions"]
};

async function callAI(prompt, type) {
  const apiKey = ""; // Disediakan oleh environment Canvas
  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

  let schema;
  if (type === 'flashcard') {
    schema = flashcardSchema;
  } else if (type === 'quiz') {
    schema = quizSchema;
  } else {
    throw new Error("Tipe unit tidak valid untuk panggilan AI");
  }

  const payload = {
    contents: [{ parts: [{ text: prompt }] }],
    generationConfig: {
      responseMimeType: "application/json",
      responseSchema: schema,
      // temperature: 0.8 (opsional)
    },
    systemInstruction: {
        parts: [{ text: "Anda adalah asisten pembuat materi pembelajaran yang membantu membuat flashcard dan kuis dalam Bahasa Indonesia." }]
    }
  };

  // Implementasi retry/backoff sederhana untuk menangani throttling (429)
  let response;
  const maxRetries = 3;
  for (let i = 0; i < maxRetries; i++) {
    try {
        response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        if (response.ok) break; // Sukses, keluar dari loop

        if (response.status !== 429) {
           // Gagal karena alasan lain, jangan coba lagi
           console.error("Panggilan API gagal dengan status:", response.status);
           throw new Error(`Panggilan API gagal: ${response.statusText}`);
        }
        
        // Jika status 429 (throttled), tunggu dan coba lagi
        // Jangan log error ini ke console
        const delay = 1000 * Math.pow(2, i) + Math.random() * 1000;
        await new Promise(res => setTimeout(res, delay));
        
    } catch (err) {
        // Tangkap error network, dll.
        if (i === maxRetries - 1) throw err; // Gagal di percobaan terakhir
        // jangan log error network sementara
    }
  }
  
  if (!response || !response.ok) {
      throw new Error("Permintaan API gagal setelah beberapa kali percobaan.");
  }

  const result = await response.json();
  const candidate = result.candidates?.[0];

  if (candidate && candidate.content?.parts?.[0]?.text) {
    try {
      // API menjamin ini adalah string JSON yang valid sesuai skema
      return JSON.parse(candidate.content.parts[0].text);
    } catch (e) {
      console.error("Gagal mem-parsing JSON dari AI, meskipun dalam mode JSON:", e);
      throw new Error("Respons JSON tidak valid dari AI");
    }
  } else {
    console.error("Struktur respons API tidak valid:", result);
    throw new Error("Tidak ada konten valid dari AI");
  }
}

/* ---------- Local fallback generators ---------- */
function generateFlashcardsLocal(title, desc, count){
  const cards = [];
  for(let i=1;i<=count;i++){
    const front = `${title} — Card ${i}`;
    const back = `Ringkasan: ${desc ? desc + ' ' : ''}Poin penting ${i}. Contoh aplikasi / catatan singkat.`;
    cards.push({id:uid('c'), front, back});
  }
  return cards;
}
function generateQuizLocal(title, desc, count, level){
  const questions = [];
  const difficulty = { easy:2, medium:3, hard:4 }[level] || 3;
  for(let i=1;i<=count;i++){
    const q = `Soal ${i}: Tentang ${title}. ${desc ? desc.slice(0,80) : ''}`;
    const choices = [];
    for(let c=0;c<difficulty+1;c++) choices.push(`Pilihan ${String.fromCharCode(65+c)}`);
    const answer = 0; // always A for local
    questions.push({id:uid('q'), question:q, choices, answer});
  }
  return questions;
}

/* ---------- App state & rendering ---------- */
let state = {
  view:'home', // not heavily used; kept for possible extension
  categoryFilter: 'Semua',
  query: '',
  decks: readStorage()
};

function getCategories(){
  const cats = new Set(['Semua']);
  state.decks.forEach(d => cats.add(d.category || 'Umum'));
  return Array.from(cats);
}

function saveDecks(){ writeStorage(state.decks); renderList(); }

function addDeck(deck){
  state.decks.unshift(deck);
  saveDecks();
  toast('Unit tersimpan');
}

/* ---------- UI wiring: categories & list ---------- */
const categoryChips = document.getElementById('category-chips');
const listRoot = document.getElementById('main-list');
const emptyState = document.getElementById('empty-state');

function renderCategories(){
  const cats = getCategories();
  categoryChips.innerHTML='';
  cats.forEach(c=>{
    const chip = el('div',{class:'chip' + (c===state.categoryFilter ? ' active' : '')}, c);
    chip.addEventListener('click', ()=>{ state.categoryFilter=c; renderCategories(); renderList(); });
    categoryChips.appendChild(chip);
  });
  // populate create modal category select
  const sel = document.getElementById('unit-category');
  sel.innerHTML='';
  cats.filter(x=>x!=='Semua').forEach(cat=>{
    const opt = el('option',{},cat);
    sel.appendChild(opt);
  });
  // always allow 'Umum' if none
  if(sel.children.length===0) sel.appendChild(el('option',{},'Umum'));
}

function renderList(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  state.query = q;
  listRoot.innerHTML='';
  let filtered = state.decks.slice();
  if(state.categoryFilter && state.categoryFilter!=='Semua') filtered = filtered.filter(d=>d.category===state.categoryFilter);
  if(q) filtered = filtered.filter(d => (d.title||'').toLowerCase().includes(q) || (d.desc||'').toLowerCase().includes(q) || (d.category||'').toLowerCase().includes(q));
  if(filtered.length===0){
    emptyState.style.display='block';
  } else {
    emptyState.style.display='none';
  }
  filtered.forEach(deck=>{
    const d = el('div',{class:'deck'});
    const typePill = el('div',{class:'type-pill ' + (deck.type==='flashcard' ? 'type-flash' : 'type-quiz')}, deck.type==='flashcard' ? 'Flashcard' : 'Quiz');
    const title = el('div',{class:'title'}, deck.title);
    const desc = el('div',{class:'desc'}, deck.desc || '');
    const meta = el('div',{class:'meta'});
    meta.appendChild(typePill);
    meta.appendChild(el('div',{style:'font-weight:700'}, deck.cards ? deck.cards.length + ' items' : (deck.questions||[]).length + ' items'));
    meta.appendChild(el('div',{class:'muted', style:'margin-left:8px'}, ' • ' + (deck.category || 'Umum')));
    const row = el('div',{class:'row'});
    const left = el('div',{}, title, desc, meta);
    const actions = el('div',{class:'deck-actions'});
    const play = el('button',{class:'action'}, 'Mainkan');
    play.addEventListener('click', ()=> openPlayer(deck.id));
    const edit = el('button',{class:'action'}, 'Pindah');
    edit.addEventListener('click', ()=> changeCategoryPrompt(deck.id));
    const del = el('button',{class:'action'}, 'Hapus');
    del.addEventListener('click', ()=> deleteDeck(deck.id));
    const share = el('button',{class:'action'}, 'Bagikan');
    share.addEventListener('click', ()=> shareDeck(deck.id));
    actions.appendChild(play); actions.appendChild(edit); actions.appendChild(share); actions.appendChild(del);

    d.appendChild(left);
    d.appendChild(actions);
    listRoot.appendChild(d);
  });
}

/* ---------- Actions: create / modal ---------- */
const modal = document.getElementById('modal');
document.getElementById('btn-create').addEventListener('click', ()=> openCreateModal());
document.getElementById('modal-close').addEventListener('click', closeCreateModal);
document.getElementById('modal-cancel').addEventListener('click', closeCreateModal);
document.getElementById('modal-create').addEventListener('click', async ()=>{
  const type = document.getElementById('unit-type').value;
  const title = document.getElementById('unit-title').value.trim() || 'Tanpa Judul';
  const desc = document.getElementById('unit-desc').value.trim() || '';
  const count = Math.max(1, Math.min(30, parseInt(document.getElementById('unit-count').value) || 5));
  const level = document.getElementById('unit-level').value;
  let category = document.getElementById('unit-category').value || 'Umum';
  const newCat = document.getElementById('new-category').value.trim();
  if(newCat) category = newCat;

  closeCreateModal();

  // show spinner
  showSpinner(true);

  // Build prompt for the AI
  const prompt = buildPrompt(type, title, desc, count, level);
  try{
    // try AI call
    // Mengirim 'prompt' dan 'type' (untuk memilih skema)
    const structured = await callAI(prompt, type);

    if(structured){
      // Map to our deck model depending on type
      if(type==='flashcard'){
        // expect structured.cards = [{front, back}, ...]
        // Validasi data yang diterima dari AI
        const cards = (structured.cards && Array.isArray(structured.cards) ? structured.cards : [])
            .map(c=>({id:uid('c'), front:c.front || '', back:c.back || ''}))
            .filter(c => c.front && c.back); // Pastikan kartu tidak kosong

        if(cards.length === 0) throw new Error("AI mengembalikan data kartu yang tidak valid");

        const deck = { id: uid('deck'), type:'flashcard', title, desc, category, created:Date.now(), cards };
        addDeck(deck);

      } else {
        // quiz -> structured.questions = [{question, choices:[...], answer: index}]
        const qs = (structured.questions && Array.isArray(structured.questions) ? structured.questions : [])
            .map(q=>{
                const choices = (q.choices && Array.isArray(q.choices)) ? q.choices : [];
                // Validasi jawaban, pastikan indeks valid
                let ans = (typeof q.answer === 'number' && q.answer >= 0 && q.answer < choices.length) ? q.answer : 0;
                return { id:uid('q'), question: q.question || '', choices, answer: ans };
            })
            .filter(q => q.question && q.choices.length > 1); // Pastikan soal & pilihan ada

        if(qs.length === 0) throw new Error("AI mengembalikan data kuis yang tidak valid");

        const deck = { id: uid('deck'), type:'quiz', title, desc, category, created:Date.now(), questions: qs };
        addDeck(deck);
      }
      showSpinner(false);
      renderCategories();
      renderList();
      return;
    } else {
      // fallback to local generator
      throw new Error('AI returned non-JSON; fallback');
    }
  }catch(err){
    // fallback: local generator
    console.warn('Panggilan AI gagal atau mengembalikan data tidak ter-parse. Menggunakan generator lokal.', err);
    let deck;
    if(type==='flashcard'){
      const cards = generateFlashcardsLocal(title, desc, count);
      deck = { id: uid('deck'), type:'flashcard', title, desc, category, created:Date.now(), cards };
    } else {
      const questions = generateQuizLocal(title, desc, count, level);
      deck = { id: uid('deck'), type:'quiz', title, desc, category, created:Date.now(), questions };
    }
    addDeck(deck);
    showSpinner(false);
    renderCategories();
    renderList();
  }
});

function buildPrompt(type, title, desc, count, level){
  const lang = "Gunakan bahasa Indonesia.";
  if(type==='flashcard'){
    // Prompt disederhanakan, tidak perlu instruksi format JSON
    return `Buatkan ${count} flashcard (kartu bolak-balik) yang singkat dan jelas tentang "${title}". Deskripsi materi: ${desc}. ${lang}`;
  } else {
    const choicesCount = { easy: 3, medium: 4, hard: 4 }[level] || 4;
    // Prompt disederhanakan, skema akan mengurus format 'answer' sebagai indeks
    return `Buatkan ${count} soal pilihan berganda (quiz) tentang "${title}" dengan tingkat kesulitan ${level}. Setiap soal harus memiliki ${choicesCount} pilihan jawaban. Deskripsi materi: ${desc}. ${lang}`;
  }
}

function openCreateModal(){
  modal.classList.add('open');
  // populate defaults
  document.getElementById('unit-title').value='';
  document.getElementById('unit-desc').value='';
  document.getElementById('unit-count').value=5;
  document.getElementById('new-category').value='';
  renderCategories();
}
function closeCreateModal(){ modal.classList.remove('open'); }

/* ---------- Deck management: delete, change category, share ---------- */
function deleteDeck(id){
  // Ganti confirm() dengan UI kustom jika memungkinkan, tapi untuk sekarang biarkan
  if(!confirm('Hapus unit ini? Tindakan tidak dapat dibatalkan.')) return;
  state.decks = state.decks.filter(d=>d.id!==id);
  saveDecks();
  renderCategories();
  toast('Unit dihapus');
}
function changeCategoryPrompt(id){
  const deck = state.decks.find(d=>d.id===id);
  if(!deck) return;
  const cats = getCategories().filter(c=>c!=='Semua');
  let newCat = prompt('Pindah ke kategori (isi nama baru untuk membuat):', deck.category || 'Umum');
  if(newCat===null) return;
  newCat = newCat.trim() || 'Umum';
  deck.category = newCat;
  saveDecks();
  renderCategories();
  toast('Kategori diperbarui');
}
function shareDeck(id){
  const deck = state.decks.find(d=>d.id===id);
  if(!deck) return;
  const payload = JSON.stringify(deck, null, 2);
  if(navigator.share){
    navigator.share({title:deck.title, text:deck.desc, url:location.href}).catch(()=>{});
  } else {
    // fallback: copy to clipboard (perlu konteks aman/HTTPS)
    try {
        // Coba API modern
        navigator.clipboard.writeText(payload).then(() => {
            toast('JSON unit disalin ke clipboard');
        }, () => {
            // Gagal (mungkin HTTP), coba execCommand
            const tempInput = el('textarea', {style:'position:absolute;left:-9999px'}, payload);
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);
            toast('JSON unit disalin ke clipboard');
        });
    } catch(e) {
        toast('Gagal menyalin');
    }
  }
}

/* ---------- Player: show flashcards / quiz ---------- */
const playerEl = document.getElementById('player');
const playerTitle = document.getElementById('player-title');
const playerType = document.getElementById('player-type');
const playerProgress = document.getElementById('player-progress');
const playCard = document.getElementById('play-card');
const faceFront = document.getElementById('face-front');
const faceBack = document.getElementById('face-back');
const frontContent = document.getElementById('front-content');
const frontSub = document.getElementById('front-sub');
const backContent = document.getElementById('back-content');
const backSub = document.getElementById('back-sub');
const quizOptionsContainer = document.getElementById('quiz-options-container');
const quizOptions = document.getElementById('quiz-options');

let playState = {
  deckId: null,
  deck: null,
  index: 0,
  flipped: false,
};

function openPlayer(deckId){
  const deck = state.decks.find(d => d.id === deckId);
  if(!deck) return;
  playState.deckId = deckId; playState.deck = deck; playState.index = 0; playState.flipped=false;
  playerTitle.textContent = deck.title;
  playerType.textContent = deck.type==='flashcard' ? 'Flashcards' : 'Quiz';
  playerProgress.textContent = '1 / ' + (deck.type==='flashcard' ? (deck.cards?.length||0) : (deck.questions?.length||0));
  // open modal
  playerEl.classList.add('open');
  renderPlayCard();
}
function closePlayer(){ playerEl.classList.remove('open'); playState.deckId=null; playState.deck=null; playState.index=0; playState.flipped=false; }

document.getElementById('player-close').addEventListener('click', closePlayer);
document.getElementById('prev-btn').addEventListener('click', ()=> {
  if(!playState.deck) return;
  playState.index = Math.max(0, playState.index-1);
  playState.flipped = false;
  renderPlayCard();
});
document.getElementById('next-btn').addEventListener('click', ()=> {
  if(!playState.deck) return;
  const length = playState.deck.type==='flashcard' ? playState.deck.cards.length : playState.deck.questions.length;
  playState.index = Math.min(length-1, playState.index+1);
  playState.flipped = false;
  renderPlayCard();
});

playCard.addEventListener('click', ()=> {
  // flip card or for quiz reveal answer/options
  playState.flipped = !playState.flipped;
  // playCard.classList.toggle('flip', playState.flipped); // <-- HAPUS BARIS INI
  renderPlayCard(); // Biarkan fungsi ini yang menangani pembaruan UI
});

function renderPlayCard(){
  const deck = playState.deck;
  if(!deck) return;
  const isFlash = deck.type==='flashcard';
  const length = isFlash ? (deck.cards?.length||0) : (deck.questions?.length||0);
  const idx = playState.index;

  if(length === 0) {
      frontContent.textContent = "Unit ini kosong.";
      return;
  }

  playerProgress.textContent = (idx+1) + ' / ' + length;

  quizOptionsContainer.style.display = isFlash ? 'none' : 'block';
  playCard.classList.toggle('flip', playState.flipped);


  if(isFlash){
    const card = deck.cards[idx];
    if(!card) return;
    frontContent.textContent = card.front;
    frontSub.textContent = `Card ${idx+1}`;
    backContent.textContent = card.back;
    backSub.textContent = `Jawaban / Penjelasan`;
  } else {
    const q = deck.questions[idx];
    if(!q) return;
    frontContent.textContent = q.question;
    frontSub.textContent = `Soal ${idx+1}`;
    backContent.textContent = ''; // Tidak dipakai di quiz
    backSub.textContent = ''; // Tidak dipakai di quiz
    // render options
    quizOptions.innerHTML = '';
    q.choices.forEach((c,ci)=>{
      const opt = el('div',{class:'option', role:'button'}, `${String.fromCharCode(65+ci)}. ${c}`);
      opt.addEventListener('click', ()=> {
        // reveal correct/wrong
        const correctIndex = q.answer;
        if(ci===correctIndex){
          opt.classList.add('correct');
          toast('Jawaban benar!');
        } else {
          opt.classList.add('wrong');
          // highlight correct
          const correctEl = Array.from(quizOptions.children)[correctIndex];
          if(correctEl) correctEl.classList.add('correct');
          toast('Jawaban salah');
        }
        // disable further clicks
        Array.from(quizOptions.children).forEach(p=> p.style.pointerEvents='none');
      });
      quizOptions.appendChild(opt);
    });
  }
}

/* ---------- Search / clear / quick API button ---------- */
document.getElementById('q').addEventListener('input', ()=> renderList());
document.getElementById('btn-clear').addEventListener('click', ()=>{
  document.getElementById('q').value=''; renderList();
});

document.getElementById('btn-sync').addEventListener('click', ()=>{
  // Ganti alert() dengan toast atau modal kustom
  toast('API: Menggunakan Gemini (Google) untuk membuat unit.', 2500);
});

/* ---------- Init ---------- */
function init(){
  renderCategories();
  renderList();
}
init();

/* ---------- Example dev seeds (only if empty) ---------- */
if(state.decks.length===0){
  console.log("Memuat data seed awal...");
  const seed = {
    id: uid('deck'),
    type: 'flashcard',
    title: 'Pancasila Inti',
    desc: 'Ringkasan sila-sila Pancasila.',
    category: 'Civics',
    created: Date.now(),
    cards: [
      {id:uid('c'), front:'Sila 1', back:'Ketuhanan Yang Maha Esa — penjelasan singkat.'},
      {id:uid('c'), front:'Sila 2', back:'Kemanusiaan yang adil dan beradab.'},
      {id:uid('c'), front:'Sila 3', back:'Persatuan Indonesia.'},
    ]
  };
  state.decks.push(seed);
  writeStorage(state.decks);
  renderCategories();
  renderList();
}

/* ---------- Keyboard accessibility: swipe via arrow keys ---------- */
document.addEventListener('keydown', (e)=>{
  if(playerEl.classList.contains('open')){
    if(e.key === 'ArrowRight') document.getElementById('next-btn').click();
    if(e.key === 'ArrowLeft') document.getElementById('prev-btn').click();
    if(e.key === 'Escape') closePlayer();
  }
});
</script>
</body>
</html>
